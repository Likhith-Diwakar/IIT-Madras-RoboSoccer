#include "IBusBM.h"

// Initialize i-BUS
IBusBM ibus;

// Motor driver pins
#define PWM1_PIN 9
#define DIR1_PIN 8
#define PWM2_PIN 10
#define DIR2_PIN 7

void setup() {
  // Start Serial1 for i-BUS communication
  Serial1.begin(115200);
  ibus.begin(Serial1);

  // Motor driver pins
  pinMode(PWM1_PIN, OUTPUT);
  pinMode(DIR1_PIN, OUTPUT);
  pinMode(PWM2_PIN, OUTPUT);
  pinMode(DIR2_PIN, OUTPUT);
}

void loop() {
  // Process incoming i-BUS data
  ibus.loop();

  // Read channel values
  int throttle = ibus.readChannel(1); // Channel 2 (Throttle)
  int steering = ibus.readChannel(0); // Channel 1 (Steering)
  int speedControl = ibus.readChannel(2); // Channel 3 (Speed Control)

  // Map i-BUS values (1000-2000) to motor control ranges
  int motorSpeed = map(throttle, 1000, 2000, -255, 255);
  int steerValue = map(steering, 1000, 2000, -255, 255);
  float speedMultiplier = map(speedControl, 1000, 2000, 0, 100) / 100.0;

  // Apply speed multiplier
  motorSpeed *= speedMultiplier;
  steerValue *= speedMultiplier;

  // Control motors based on throttle and steering
  controlMotors(motorSpeed, steerValue);
}

void controlMotors(int speed, int steer) {
  // Calculate motor speeds
  int leftMotorSpeed = constrain(speed - steer, -255, 255);
  int rightMotorSpeed = constrain(speed + steer, -255, 255);

  // Left motor control
  digitalWrite(DIR1_PIN, leftMotorSpeed > 0 ? HIGH : LOW);
  analogWrite(PWM1_PIN, abs(leftMotorSpeed));

  // Right motor control
  digitalWrite(DIR2_PIN, rightMotorSpeed > 0 ? HIGH : LOW);
  analogWrite(PWM2_PIN, abs(rightMotorSpeed));
}
